<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Busca LATAM — Brasil (IATA), Data e Origem</title>
  <style>
    :root{ --bg:#0b1020; --card:#10172a; --muted:#b5bfd1; --text:#e8eefc; --accent:#7aa2ff; --ok:#16a34a; --warn:#f59e0b; --err:#ef4444; --line: rgba(255,255,255,.12); }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{ margin:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial; color:var(--text); background:radial-gradient(1200px 600px at 10% -10%, #1a254b 0, transparent 70%), radial-gradient(1000px 500px at 120% 10%, #0e1739 0, transparent 60%), var(--bg); }

    .wrap{ max-width:1100px; margin:40px auto; padding:24px; }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:16px; padding:24px; box-shadow: 0 8px 24px rgba(0,0,0,.35); }

    h1{ font-size: clamp(1.15rem, 1vw + .9rem, 1.6rem); margin:0 0 12px; font-weight:700; letter-spacing:.2px }
    p.lead{ color:var(--muted); margin:.25rem 0 1rem; }

    .notice{ background:#0b1329; border:1px solid var(--line); border-left:4px solid var(--accent); border-radius:12px; padding:14px 16px; color:#c9d6ff; margin: 12px 0 18px; }
    .notice b{ color:#e8eefc }

    .grid{ display:grid; gap:16px; grid-template-columns: 1fr; }
    @media (min-width: 1100px){ .grid{ grid-template-columns: 1fr 1fr 1fr 1fr; } }

    label{ display:block; font-size:.85rem; color:var(--muted); margin:0 0 6px 2px; }
    input, button, select{ width:100%; border-radius:12px; padding:12px 14px; border:1px solid var(--line); background:#0b1329; color:var(--text); outline:none; }
    input:focus, select:focus{ border-color: var(--accent); box-shadow: 0 0 0 3px rgba(122,162,255,.15); }

    .actions{ display:flex; flex-wrap:wrap; gap:12px; margin-top: 14px; align-items:center }
    .btn{ cursor:pointer; border:1px solid transparent; font-weight:600; letter-spacing:.2px; width:auto }
    .btn-primary{ background:linear-gradient(180deg, var(--accent), #3b82f6); border-color:#3b82f6 }
    .btn-ghost{ background:transparent; border-color:var(--line); color:var(--muted) }
    .btn:disabled{ opacity:.6; cursor:not-allowed }

    .msg{ margin-top:10px; font-size:.9rem }
    .msg.ok{ color: var(--ok) }
    .msg.err{ color: var(--err) }

    small.hint{ color: var(--muted); display:block; margin-top:6px }

    details.testpanel{ margin-top:18px; border-top:1px dashed var(--line); padding-top:14px }
    .test-pass{ color: var(--ok) }
    .test-fail{ color: var(--err) }
    .test-item{ margin:.2rem 0 }

    .chipbar{ display:flex; flex-wrap:wrap; gap:8px; margin-top:10px }
    .chip{ display:inline-flex; align-items:center; gap:8px; border:1px solid var(--line); background:#0b1329; color:#fff; padding:6px 10px; border-radius:999px; font-size:.85rem }
    .chip .rm{ cursor:pointer; border:none; background:transparent; color:var(--muted); font-weight:700 }
    .chip .rm:hover{ color:#fff }

    .rel{ position:relative }
    .dropdown{ position:absolute; left:0; right:0; top:100%; margin-top:6px; background:#0b1329; border:1px solid var(--line); border-radius:12px; max-height:280px; overflow:auto; display:none; z-index:50 }
    .dropdown .opt{ padding:8px 10px; cursor:pointer; border-bottom:1px dashed rgba(255,255,255,.06) }
    .dropdown .opt:last-child{ border-bottom:none }
    .dropdown .opt:hover{ background:#0e1739 }

    .country{ margin-top:16px; border-top:1px dashed var(--line); padding-top:16px }
    .country .grid2{ display:grid; gap:12px; grid-template-columns: 1fr; }
    @media (min-width: 1100px){ .country .grid2{ grid-template-columns: 1fr 2fr 1fr; } }
    #countryAirports{ min-height:240px }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1 id="titleH1">Busca de voos LATAM — múltiplos destinos (<span id="ivTitle">15</span>s entre cada)</h1>
      <p class="lead">Selecione <strong>origem</strong>, <strong>destino(s)</strong> (nome completo ou IATA) e a <strong>data</strong>.</p>

      <div class="notice" role="note" aria-label="Como funciona">
        <b>Como funciona & pré-requisitos</b>
        <ol>
          <li><b>Faça login</b> na LATAM em outra aba antes de usar (obrigatório).</li>
          <li>Autorize <b>pop-ups</b> para este site.</li>
          <li>No <b>celular/Safari</b>, uma <b>aba lançadora</b> aparece; toque em <b>Abrir próxima aba</b> (ou “Abrir 3 abas”).</li>
          <li>Criamos <b>abas de espera</b> que se abrem sozinhas em intervalos.</li>
        </ol>
      </div>

      <div class="grid">
        <div>
          <label for="origin">Origem (IATA)</label>
          <div class="rel">
            <input id="origin" maxlength="3" pattern="[A-Za-z]{3}" placeholder="Ex.: BSB, GRU, EZE" />
            <div class="dropdown" id="drop-origin" role="listbox" aria-label="Sugestões de origem"></div>
          </div>
          <small class="hint">Origem deve ser IATA (3 letras).</small>
        </div>

        <div>
          <label for="destination">Destino (nome completo ou IATA)</label>
          <div class="rel">
            <input id="destination" placeholder="Ex.: São Paulo Guarulhos, Salvador, Florianópolis, SCL..." />
            <div class="dropdown" id="drop-dest" role="listbox" aria-label="Sugestões de destino"></div>
          </div>
          <div class="actions">
            <button id="addDest" class="btn btn-ghost" type="button">Adicionar destino</button>
            <button id="clearDests" class="btn btn-ghost" type="button">Limpar destinos</button>
          </div>
          <div id="destChips" class="chipbar" aria-live="polite"></div>
          <small class="hint">Guardamos apenas o código IATA.</small>
        </div>

        <div>
          <label for="date">Data</label>
          <input id="date" type="date" />
          <small class="hint">A data mínima é hoje. O horário será <code>15:00:00Z</code>.</small>
        </div>

        <div>
          <label for="interval">Intervalo entre abas (segundos)</label>
          <input id="interval" type="number" min="3" max="120" step="1" value="15" />
          <small class="hint">Mínimo 3s.</small>
        </div>
      </div>

      <!-- Seleção por país (até 10) -->
      <div class="country">
        <label><strong>Selecionar por país (até 10 aeroportos)</strong></label>
        <div class="grid2">
          <div>
            <label for="countrySelect">País</label>
            <select id="countrySelect"></select>
            <small class="hint">Escolha um país para listar seus aeroportos.</small>
          </div>
          <div>
            <label for="countryAirports">Aeroportos do país (selecione até 10)</label>
            <select id="countryAirports" multiple size="12" aria-label="Aeroportos do país"></select>
            <small class="hint">Use Ctrl/Cmd para múltiplos. Limite: 10 por vez.</small>
          </div>
          <div>
            <label for="countryFilter">Filtrar (nome/cidade/IATA)</label>
            <input id="countryFilter" placeholder="Ex.: Guarulhos, Salvador, SSA..." />
            <div class="actions">
              <button id="addFromCountry" class="btn btn-ghost" type="button">Adicionar selecionados</button>
              <button id="clearCountrySel" class="btn btn-ghost" type="button">Limpar seleção</button>
            </div>
          </div>
        </div>
      </div>

      <div class="actions">
        <button id="go" class="btn btn-primary" type="button" disabled>Buscar na LATAM</button>
        <button id="stop" class="btn btn-ghost" type="button" disabled>Parar fila</button>
        <button id="clear" class="btn btn-ghost" type="button">Limpar tudo</button>
        <span id="waitBox" class="msg" aria-live="polite"></span>
      </div>

      <div class="result" id="result" hidden>
        <div>Resumo:</div>
        <div class="result-code" id="paramsOut"></div>
        <div id="status" class="msg"></div>
      </div>

      <details class="testpanel" id="testPanel">
        <summary>Testes automatizados (dev)</summary>
        <div id="testReport"></div>
      </details>
    </div>
  </div>

  <script>
    if (!window.__LATAM_WIDGET_INIT__) {
      window.__LATAM_WIDGET_INIT__ = true;

      // ====== CONFIG ======
      const COOLDOWN_DEFAULT = 15;                 // intervalo padrão entre abas
      const FIRST_DELAY_MOBILE_SECONDS = 3;        // atraso inicial em mobile/safari (garante abrir todas)
      const LATAM_BASE = 'https://www.latamairlines.com/br/pt/oferta-voos';
      const USE_EXP_ID = true;                     // id aleatório por aba
      const FORCE_WEB_PARAM = { channel: 'web' };  // reforça web

      // Países (ISO2 -> nome PT-BR) — conjunto básico
      const ISO_TO_PT = {
        BR:'Brasil', AR:'Argentina', CL:'Chile', UY:'Uruguai', PY:'Paraguai', BO:'Bolívia', PE:'Peru',
        CO:'Colômbia', EC:'Equador', VE:'Venezuela', US:'Estados Unidos', CA:'Canadá', MX:'México',
        PT:'Portugal', ES:'Espanha', FR:'França', GB:'Reino Unido', DE:'Alemanha', IT:'Itália',
        NL:'Países Baixos', AU:'Austrália', NZ:'Nova Zelândia', ZA:'África do Sul', JP:'Japão',
        CN:'China', AE:'Emirados Árabes Unidos', QA:'Catar', TR:'Turquia'
      };
      const NAME_TO_ISO = {
        'BRAZIL':'BR','BRASIL':'BR','ARGENTINA':'AR','CHILE':'CL','URUGUAY':'UY','URUGUAI':'UY','PARAGUAY':'PY','PARAGUAI':'PY','BOLIVIA':'BO','PERU':'PE',
        'COLOMBIA':'CO','ECUADOR':'EC','EQUADOR':'EC','VENEZUELA':'VE','UNITED STATES':'US','ESTADOS UNIDOS':'US','CANADA':'CA','CANADÁ':'CA',
        'MEXICO':'MX','MÉXICO':'MX','PORTUGAL':'PT','SPAIN':'ES','ESPANHA':'ES','FRANCE':'FR','FRANÇA':'FR',
        'UNITED KINGDOM':'GB','REINO UNIDO':'GB','GERMANY':'DE','ALEMANHA':'DE','ITALY':'IT','ITÁLIA':'IT','NETHERLANDS':'NL','PAÍSES BAIXOS':'NL',
        'AUSTRALIA':'AU','NEW ZEALAND':'NZ','SOUTH AFRICA':'ZA','ÁFRICA DO SUL':'ZA','JAPAN':'JP','JAPÃO':'JP',
        'CHINA':'CN','UNITED ARAB EMIRATES':'AE','EMIRADOS ÁRABES UNIDOS':'AE','QATAR':'QA','CATAR':'QA','TURKEY':'TR','TURQUIA':'TR'
      };

      // Fallback offline (BR básico)
      const BR_IATA = ['GRU','CGH','VCP','GIG','SDU','BSB','CNF','CWB','POA','FLN','REC','FOR','NAT','AJU','VIX','GYN','SLZ','SSA','BEL','MAO'];
      const FALLBACK_BR = BR_IATA.map(code => ({iata:code, city:'', name:'', country:'BR'}));

      // Estado
      const $ = (sel, p=document) => p.querySelector(sel);
      let AIRPORTS = [];            // [{iata,city,name,cc,countryName}]
      let DROPDOWN_ITEMS = [];      // [{label, code}]
      let COUNTRY_LIST = [];        // [{cc, name}]
      let LAST_COUNTRY = 'BR';
      let queueShells = [];
      const dests = new Set();

      // ===== Helpers UA =====
      function isMobile(){
        return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      }
      function isSafari(){
        const ua = navigator.userAgent;
        const vendor = navigator.vendor;
        return /Safari/.test(ua) && /Apple/.test(vendor || '') && !/CriOS|FxiOS|EdgiOS|OPiOS|Chrome|Android/i.test(ua);
      }

      // ===== Helpers gerais =====
      function getCooldown(){
        const el = $('#interval');
        const min = parseInt(el.min,10) || 3;
        const max = parseInt(el.max,10) || 120;
        let v = parseInt(el.value || COOLDOWN_DEFAULT,10);
        if (isNaN(v)) v = COOLDOWN_DEFAULT;
        v = Math.max(min, Math.min(max, v));
        el.value = String(v);
        return v;
      }
      function getFirstDelay(){ return (isMobile() ? Math.max(3, FIRST_DELAY_MOBILE_SECONDS) : 0); }
      function updateIntervalTexts(){
        const v = getCooldown();
        ['iv','iv2','ivTitle'].forEach(id => { const s = document.getElementById(id); if(s) s.textContent = String(v); });
      }
      function setMinDateToday(){
        const now = new Date();
        const yyyy = now.getFullYear();
        const mm = String(now.getMonth()+1).padStart(2,'0');
        const dd = String(now.getDate()).padStart(2,'0');
        const iso = `${yyyy}-${mm}-${dd}`;
        $('#date').min = iso;
        if(!$('#date').value) $('#date').value = iso;
      }
      function upcaseIATA(inp){ inp.addEventListener('input', ()=>{ inp.value = inp.value.replace(/[^a-zA-Z]/g,'').toUpperCase().slice(0,3); updateGoState(); }); }

      // ===== País / airports util =====
      function normalizeCountryFields(a){
        let codeCandidate = (a.iso || a.iso_country || a.country_code || a.country || '').toString().trim();
        let cc = '';
        let name = '';
        if (codeCandidate.length === 2) {
          cc = codeCandidate.toUpperCase();
          name = ISO_TO_PT[cc] || a.country_name || a.country || cc;
        } else {
          const key = codeCandidate.toUpperCase();
          cc = NAME_TO_ISO[key] || '';
          name = codeCandidate || (ISO_TO_PT[cc] || cc);
        }
        if (!cc) { cc = 'XX'; }
        if (!name) { name = ISO_TO_PT[cc] || cc; }
        return { cc, name };
      }
      function airportsToInternal(list){
        return list
          .filter(a => a && a.iata && /^[A-Z]{3}$/i.test(a.iata))
          .map(a => {
            const {cc,name:countryName} = normalizeCountryFields(a);
            return { iata: a.iata.toUpperCase(), city: a.city||'', name: a.name||'', cc, countryName };
          });
      }
      function buildCountryList(list){
        const map = new Map();
        list.forEach(a => {
          const cc = (a.cc||a.country||'').toString().toUpperCase();
          if (!cc) return;
          if (!map.has(cc)) map.set(cc, a.countryName || ISO_TO_PT[cc] || cc);
        });
        return Array.from(map.entries())
          .map(([cc, name]) => ({cc, name}))
          .sort((x,y)=> x.name.localeCompare(y.name, 'pt-BR'));
      }
      function populateCountrySelect(){
        const sel = $('#countrySelect');
        sel.innerHTML = COUNTRY_LIST.map(c => `<option value="${c.cc}">${c.cc} — ${c.name}</option>`).join('');
        sel.value = COUNTRY_LIST.find(c => c.cc===LAST_COUNTRY)?.cc || COUNTRY_LIST[0]?.cc || '';
      }
      function airportsByCountry(cc){
        const code = (cc||'').toUpperCase();
        return AIRPORTS
          .filter(a => (a.cc||'').toUpperCase() === code)
          .sort((a,b) => (a.city||'').localeCompare(b.city||'') || (a.name||'').localeCompare(b.name||''));
      }
      function renderCountryAirports(cc, filterText=''){
        const box = $('#countryAirports');
        const q = (filterText||'').toUpperCase().normalize('NFD').replace(/\p{Diacritic}/gu,'');
        const list = airportsByCountry(cc).filter(a=>{
          if(!q) return true;
          const s = `${a.iata} ${a.city||''} ${a.name||''}`.toUpperCase().normalize('NFD').replace(/\p{Diacritic}/gu,'');
          return s.includes(q);
        });
        box.innerHTML = list.map(a => `<option value="${a.iata}">${a.iata} — ${a.city||''}${a.city&&a.name?' • ':''}${a.name||''}</option>`).join('');
      }

      // ====== Fetch IATAs ======
      async function fetchIATAsFromCDN(timeoutMs=8000){
        const ctrl = new AbortController();
        const timer = setTimeout(()=>ctrl.abort(), timeoutMs);
        try{
          const url = 'https://cdn.jsdelivr.net/gh/mwgg/Airports/airports.json';
          const res = await fetch(url, { signal: ctrl.signal, cache: 'force-cache' });
          if(!res.ok) throw new Error('HTTP '+res.status);
          const data = await res.json();
          return Object.values(data);
        } finally { clearTimeout(timer); }
      }
      function buildDropdownItems(list){
        return list.map(a => ({ label: `${a.iata} — ${a.city||''}${a.city&&a.name?' • ':''}${a.name||''}`.trim(), code: a.iata }));
      }
      async function loadAirportsWithFallback(){
        AIRPORTS = airportsToInternal(FALLBACK_BR);
        DROPDOWN_ITEMS = buildDropdownItems(AIRPORTS);
        attachDropdown($('#destination'), $('#drop-dest'), DROPDOWN_ITEMS);
        const originItems = BR_IATA.map(code => ({label: code, code}));
        attachDropdown($('#origin'), $('#drop-origin'), originItems);

        COUNTRY_LIST = buildCountryList(AIRPORTS);
        populateCountrySelect();
        renderCountryAirports($('#countrySelect').value);

        $('#status').className='msg'; $('#status').textContent='Carregando lista global de IATAs…';
        try{
          const raw = await fetchIATAsFromCDN();
          AIRPORTS = airportsToInternal(raw);
          DROPDOWN_ITEMS = buildDropdownItems(AIRPORTS);
          attachDropdown($('#destination'), $('#drop-dest'), DROPDOWN_ITEMS);
          const originGlobal = AIRPORTS.map(a => ({label: a.iata, code: a.iata}));
          attachDropdown($('#origin'), $('#drop-origin'), originGlobal);

          COUNTRY_LIST = buildCountryList(AIRPORTS);
          populateCountrySelect();
          renderCountryAirports($('#countrySelect').value);

          $('#status').className='msg ok'; $('#status').textContent='Lista IATA carregada (CDN).';
        } catch(e){
          $('#status').className='msg err'; $('#status').textContent='CDN indisponível — usando lista offline (BR).';
        }
      }

      // ====== Dropdown manual ======
      function attachDropdown(input, drop, items){
        const show = (arr) => {
          if(!arr.length){ drop.style.display='none'; return; }
          drop.innerHTML = arr.slice(0,80).map(it => `<div class="opt" data-code="${it.code}">${it.label}</div>`).join('');
          drop.style.display='block';
          drop.querySelectorAll('.opt').forEach(el => {
            el.addEventListener('mousedown', (e)=>{
              const code = e.currentTarget.getAttribute('data-code');
              input.value = code;
              input.dispatchEvent(new Event('input'));
              drop.style.display='none';
              if(input.id==='destination'){ addDestination(code); }
            });
          });
        };
        input.addEventListener('focus', ()=> show(items));
        input.addEventListener('input', ()=>{
          const q = input.value.toUpperCase().normalize('NFD').replace(/\p{Diacritic}/gu,'');
          const filtered = items.filter(it => {
            const norm = it.label.toUpperCase().normalize('NFD').replace(/\p{Diacritic}/gu,'');
            return norm.includes(q);
          });
          show((q && filtered.length) ? filtered : items);
          updateGoState();
        });
        input.addEventListener('blur', ()=> setTimeout(()=> drop.style.display='none', 180));
        if(input.id === 'destination'){
          input.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); addDestination(input.value); } });
        }
      }

      // ====== Resolver texto -> IATA ======
      function resolveToIATA(text){
        const t = (text||'').trim();
        if(!t) return '';
        const m = t.toUpperCase().match(/\b[A-Z]{3}\b/);
        if(m) return m[0];
        const q = t.toUpperCase().normalize('NFD').replace(/\p{Diacritic}/gu,'');
        const found = AIRPORTS.find(a => {
          const city = (a.city||'').toUpperCase().normalize('NFD').replace(/\p{Diacritic}/gu,'');
          const name = (a.name||'').toUpperCase().normalize('NFD').replace(/\p{Diacritic}/gu,'');
          return city.includes(q) || name.includes(q);
        });
        return found ? found.iata.toUpperCase() : '';
      }

      // ====== Validação ======
      function isTodayOrFuture(ymd){
        const [y,m,d] = ymd.split('-').map(Number);
        const sel = new Date(y, m-1, d, 0, 0, 0, 0);
        const today = new Date(); today.setHours(0,0,0,0);
        return sel >= today;
      }
      function validate(origin, destination, date){
        if(!/^[A-Z]{3}$/.test(origin)) return { ok:false, msg:'Origem inválida. Use código IATA (3 letras).' };
        if(!/^[A-Z]{3}$/.test(destination)) return { ok:false, msg:'Destino inválido. Use código IATA (3 letras) ou escolha uma sugestão.' };
        if(!date) return { ok:false, msg:'Selecione a data da ida.' };
        if(!isTodayOrFuture(date)) return { ok:false, msg:'Data no passado. Escolha hoje ou uma data futura.' };
        return { ok:true, msg:'' };
      }

      const uuidv4 = ()=> window.crypto && crypto.randomUUID ? crypto.randomUUID() : 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => { const r = Math.random()*16|0, v = c==='x'?r:(r&0x3|0x8); return v.toString(16); });
      function buildLatamURL({ origin, destination, date }){
        const [y,m,d] = date.split('-').map(Number);
        const outboundISO = new Date(Date.UTC(y, m-1, d, 15, 0, 0)).toISOString();
        const params = {
          origin: origin.toUpperCase(),
          outbound: outboundISO,
          destination: destination.toUpperCase(),
          adt:'1', chd:'0', inf:'0',
          trip:'OW', cabin:'Economy',
          redemption:'true', sort:'RECOMMENDED'
        };
        if (USE_EXP_ID) params.exp_id = uuidv4();
        Object.entries(FORCE_WEB_PARAM).forEach(([k,v])=> params[k]=v);
        const qp = new URLSearchParams(params);
        return `${LATAM_BASE}?${qp.toString()}`;
      }

      // ====== Destinos (chips) ======
      function addDestination(inputValue){
        const code = resolveToIATA(inputValue);
        if(!code){
          $('#status').className='msg err';
          $('#status').textContent='Não foi possível identificar o IATA a partir do texto informado.';
          return {ok:false};
        }
        dests.add(code);
        renderDestChips();
        $('#destination').value='';
        $('#status').textContent='';
        updateGoState();
        return {ok:true};
      }
      const removeDestination = (code)=>{ dests.delete(code); renderDestChips(); updateGoState(); };
      const clearDestinations = ()=>{ dests.clear(); renderDestChips(); updateGoState(); };
      function renderDestChips(){
        const box = $('#destChips'); if(!box) return;
        if(dests.size===0){ box.innerHTML = '<span class="hint">(Nenhum destino adicionado)</span>'; return; }
        box.innerHTML = Array.from(dests).map(c=>`<span class="chip">${c}<button class="rm" type="button" data-code="${c}" aria-label="Remover ${c}">×</button></span>`).join('');
        box.querySelectorAll('.rm').forEach(btn=> btn.addEventListener('click', ()=> removeDestination(btn.dataset.code)) );
      }

      // ====== Desktop: abre todas as abas no mesmo clique ======
      function preopenShellTabsDesktop(urls, cooldownSec, targets){
        return urls.map((u, idx) => {
          const delaySec = Math.max(0, Math.ceil((targets[idx] - Date.now())/1000));
          const w = window.open('about:blank', '_blank');
          if (w && w.document) {
            try {
              const uAttr = u.replace(/&/g, '&amp;').replace(/"/g, '&quot;');
              const html = `<!doctype html><html><head><meta charset="utf-8">
<title>Agendado (${delaySec}s)</title>
<meta http-equiv="refresh" content="${delaySec};url=${uAttr}">
<meta name="referrer" content="no-referrer">
<style>body{font-family:system-ui,Segoe UI,Roboto,Arial;padding:24px;color:#111}</style>
</head><body><p style="color:#666">Abrirá automaticamente em ${delaySec}s…</p>
<script>(function(){var ms=${delaySec}*1000,u="${u.replace(/"/g,'\\"')}";if(ms<=0){try{location.replace(u)}catch(e){};return}setTimeout(function(){try{location.replace(u)}catch(e){}},ms+50)})();<\/script>
</body></html>`;
              w.document.open(); w.document.write(html); w.document.close();
            } catch (e) {}
          }
          return w;
        });
      }

      // ====== Mobile/Safari: aba lançadora com abertura em lotes ======
      function openViaLauncherSafari(urls, targets, cooldownSec){
        const launcher = window.open('', '_blank');
        if (!launcher) return [];

        const urlsJSON = JSON.stringify(urls);
        const tgtsJSON = JSON.stringify(targets);

        const html = `<!doctype html><html><head><meta charset="utf-8">
<title>Lançador de buscas</title>
<meta name="referrer" content="no-referrer">
<style>
body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;padding:24px;color:#111;background:#f7f7fb}
h2{margin:0 0 12px} p{margin:0 0 12px;color:#444}
button{font-size:16px;padding:12px 16px;border-radius:12px;border:1px solid #dde;cursor:pointer;background:#fff;box-shadow:0 2px 6px rgba(0,0,0,.08);margin-right:8px}
small{color:#666;display:block;margin-top:8px}
#info{margin-top:10px;color:#2563eb}
</style></head><body>
  <h2>Pronto para abrir as abas</h2>
  <p>Safari limita múltiplas abas por toque. Use os botões abaixo.</p>
  <div>
    <button id="open1">Abrir próxima aba</button>
    <button id="open3">Abrir 3 abas</button>
  </div>
  <small>Agendamento preservado: primeira ~${getFirstDelay()}s; intervalo ${cooldownSec}s.</small>
  <div id="info"></div>
  <script>
    (function(){
      var URLS = ${urlsJSON};
      var TARGETS = ${tgtsJSON}; // epoch ms por índice
      var opened = 0;

      function mk(u, targetMs){
        var delaySec = Math.max(0, Math.ceil((targetMs - Date.now())/1000));
        var w = window.open('about:blank','_blank'); if(!w) return false;
        try{
          var uAttr = u.replace(/&/g,'&amp;').replace(/"/g,'&quot;');
          var html = '<!doctype html><html><head><meta charset="utf-8"><title>Agendado ('+delaySec+'s)</title>'+
                     '<meta http-equiv="refresh" content="'+delaySec+';url='+uAttr+'">'+
                     '<meta name="referrer" content="no-referrer">'+
                     '<style>body{font-family:system-ui,Segoe UI,Roboto,Arial;padding:24px;color:#111}</style></head><body>'+
                     '<p style="color:#666">Abrirá automaticamente em '+delaySec+'s…</p>'+
                     '<script>(function(){var ms='+delaySec+'*1000,u="'+u.replace(/"/g,'\\\\"')+'";if(ms<=0){try{location.replace(u)}catch(e){};return}setTimeout(function(){try{location.replace(u)}catch(e){}},ms+50)})();<\\/script>'+
                     '</body></html>';
          w.document.open(); w.document.write(html); w.document.close();
        }catch(e){}
        return true;
      }

      function openBatch(n){
        var ok = true, count = 0;
        while(count < n && opened < URLS.length){
          ok = mk(URLS[opened], TARGETS[opened]) && ok;
          opened++; count++;
        }
        var left = URLS.length - opened;
        var el = document.getElementById('info');
        el.textContent = (left>0)
          ? ('Abertas '+opened+'/'+URLS.length+'. Toque novamente para abrir mais '+Math.min(3,left)+'.')
          : 'Todas as abas foram abertas. Você pode fechar esta janela.';
        if(!ok){ el.textContent += ' (Algumas abas podem ter sido bloqueadas.)'; }
      }

      document.getElementById('open1').addEventListener('click', function(){ openBatch(1); });
      document.getElementById('open3').addEventListener('click', function(){ openBatch(3); });
    })();
  <\/script>
</body></html>`;
        try { launcher.document.open(); launcher.document.write(html); launcher.document.close(); } catch(e){}
        return [launcher];
      }

      function runQueueWithShells(shells){
        queueShells = shells.slice();
        if (queueShells.some(w => !w)) {
          $('#status').className = 'msg err';
          $('#status').textContent = 'Pop-ups bloqueados. Habilite pop-ups e tente novamente.';
          return;
        }
        $('#stop').disabled = false;
      }

      function stopQueue(){
        if (queueShells && queueShells.length){
          queueShells.forEach(w => {
            try { if (w && w.location && String(w.location).startsWith('about:blank')) w.close(); } catch(e){}
          });
        }
        $('#stop').disabled = true;
        $('#waitBox').textContent = 'Fila interrompida.';
      }

      function updateOutput(params){
        $('#result').hidden=false;
        $('#paramsOut').textContent = JSON.stringify(params, null, 2);
      }

      function canSearch(){
        const dateOk = !!$('#date').value;
        const hasChips = dests.size > 0;
        const textIata = resolveToIATA($('#destination').value);
        return dateOk && (hasChips || !!textIata);
      }
      function updateGoState(){ $('#go').disabled = !canSearch(); }

      // ====== Bind ======
      function bind(){
        setMinDateToday();
        $('#interval').value = String(COOLDOWN_DEFAULT);
        updateIntervalTexts();
        $('#interval').addEventListener('input', updateIntervalTexts);

        upcaseIATA($('#origin'));
        renderDestChips();
        loadAirportsWithFallback();

        // País
        $('#countrySelect').addEventListener('change', (e)=>{ LAST_COUNTRY = e.target.value; renderCountryAirports(LAST_COUNTRY, $('#countryFilter').value); });
        $('#countryFilter').addEventListener('input', ()=> renderCountryAirports($('#countrySelect').value, $('#countryFilter').value));
        $('#countryAirports').addEventListener('change', ()=> {
          const box = $('#countryAirports');
          const sel = Array.from(box.selectedOptions);
          if(sel.length > 10){
            Array.from(box.options).forEach(o => o.selected = false);
            sel.slice(0,10).forEach(o => o.selected = true);
            $('#status').className='msg err';
            $('#status').textContent='Limite de 10 aeroportos por seleção atingido.';
          }
        });
        $('#addFromCountry').addEventListener('click', ()=>{
          const box = $('#countryAirports');
          const selected = Array.from(box.selectedOptions).slice(0,10).map(o => o.value.toUpperCase());
          if(selected.length === 0){
            $('#status').className='msg err'; $('#status').textContent='Selecione até 10 aeroportos no combo do país.'; return;
          }
          selected.forEach(code => dests.add(code));
          renderDestChips();
          $('#status').className='msg ok'; $('#status').textContent=`Adicionados ${selected.length} aeroporto(s).`;
          updateGoState();
        });
        $('#clearCountrySel').addEventListener('click', ()=>{ Array.from($('#countryAirports').options).forEach(o=>o.selected=false); });

        // Inputs & botões
        $('#addDest').addEventListener('click', ()=> addDestination($('#destination').value));
        $('#clearDests').addEventListener('click', clearDestinations);
        $('#stop').addEventListener('click', stopQueue);
        $('#destination').addEventListener('input', updateGoState);
        $('#date').addEventListener('change', updateGoState);

        // Buscar
        $('#go').addEventListener('click', () => {
          if (!canSearch()) return;

          const cooldownSec = getCooldown();
          updateIntervalTexts();

          const origin = $('#origin').value.trim().toUpperCase();
          const date = $('#date').value;

          const explicit = Array.from(dests);
          const fallbackSingle = resolveToIATA($('#destination').value);
          const destinations = explicit.length ? explicit : (fallbackSingle ? [fallbackSingle] : []);
          if (destinations.length===0){
            $('#status').className='msg err'; $('#status').textContent='Adicione ao menos um destino.'; return;
          }

          // valida e monta URLs
          const urls=[];
          for(const dest of destinations){
            const val=validate(origin,dest,date);
            if(!val.ok){ $('#status').className='msg err'; $('#status').textContent = `Destino ${dest}: ${val.msg}`; return; }
            urls.push( buildLatamURL({ origin, destination: dest, date }) );
          }

          // agenda absoluta: primeira ~3s (mobile), demais no intervalo
          const firstDelay = getFirstDelay();
          const startBase = Date.now() + 300; // leve folga
          const targets = urls.map((_, i) => startBase + ((firstDelay + i*cooldownSec) * 1000));

          updateOutput({ origin, destinos: destinations, data: date, intervalo_s: cooldownSec, first_delay_s: firstDelay, safari: isSafari(), mobile: isMobile() });

          let shells=[];
          if (isSafari()) {
            shells = openViaLauncherSafari(urls, targets, cooldownSec); // abre via botões (1 ou 3 por toque)
            $('#waitBox').textContent = `Aba lançadora aberta: toque em “Abrir próxima aba” até concluir.`;
          } else if (isMobile()) {
            // mobile não-Safari: ainda pode bloquear múltiplas; usar lançadora também
            shells = openViaLauncherSafari(urls, targets, cooldownSec);
            $('#waitBox').textContent = `Aba lançadora aberta: use os botões para abrir as abas.`;
          } else {
            shells = preopenShellTabsDesktop(urls, cooldownSec, targets);
            $('#waitBox').textContent = `Abas agendadas: abrirão automaticamente (intervalo ${cooldownSec}s).`;
          }

          if(shells.length===0 || shells.some(w=>!w)){
            $('#status').className='msg err';
            $('#status').textContent='Pop-ups bloqueados. Permita pop-ups e clique novamente.';
            return;
          }
          runQueueWithShells(shells);
        });

        // Limpar
        $('#clear').addEventListener('click', () => {
          $('#origin').value=''; $('#destination').value='';
          $('#interval').value=String(COOLDOWN_DEFAULT); updateIntervalTexts();
          setMinDateToday(); $('#result').hidden=true;
          $('#status').textContent=''; $('#waitBox').textContent='';
          $('#stop').disabled=true; clearDestinations();
          $('#countryFilter').value='';
          renderCountryAirports($('#countrySelect').value, '');
          Array.from($('#countryAirports').options).forEach(o=>o.selected=false);
          updateGoState();
        });

        updateGoState();
        runSelfTests();
      }

      document.addEventListener('DOMContentLoaded', bind);

      // ====== TESTES ======
      function tassert(name, cond){
        const div=document.createElement('div');
        div.className='test-item '+(cond?'test-pass':'test-fail');
        div.textContent=(cond?'✔ ':'✘ ')+name;
        document.getElementById('testReport').appendChild(div);
      }
      function runSelfTests(){
        const panel = document.getElementById('testPanel'); if(panel) panel.open=false;
        tassert('Intervalo mínimo = 3', (function(){ const el=document.getElementById('interval'); return el && el.min==='3'; })());
        tassert('Botão Buscar inicia desabilitado', document.getElementById('go').disabled === true);
        tassert('buildLatamURL fn', typeof buildLatamURL==='function');
        const sample = buildLatamURL({ origin:'BSB', destination:'SCL', date:'2025-10-11' });
        try{
          const [base,qs]=sample.split('?'); const sp=new URLSearchParams(qs);
          tassert('Base correta', base===LATAM_BASE);
          tassert('origin=BSB', sp.get('origin')==='BSB');
          tassert('destination=SCL', sp.get('destination')==='SCL');
          tassert('outbound=2025-10-11T15:00:00.000Z', sp.get('outbound')==='2025-10-11T15:00:00.000Z');
        }catch(e){ tassert('Parsing URL exemplo', false); }
      }
    }
  </script>
  <datalist id="airportsBR"></datalist>
</body>
</html>
